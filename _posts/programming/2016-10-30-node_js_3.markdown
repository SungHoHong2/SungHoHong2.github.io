---
published: true
title: Node Js Chat server 
layout: post
category: programming
permalink: /programming/node_3
---


#### app.js 

``` javascript

var express= require('express');
var app = express();
var server = require('http').createServer(app);
io = require('socket.io').listen(server);


server.listen(8000);


users = {};

app.get('/', function(req,res){
    res.sendfile(__dirname+'/index.html')
});


io.sockets.on('connection',function(socket){

    socket.on('new user', function(data, callback){
            if (data in users){
                callback(false);
            }else{
                callback(true);
                socket.nickname = data;
                users[socket.nickname] = socket;
                updateNicknames();
            }
    });


    function updateNicknames(){
                io.sockets.emit('usernames', Object.keys(users));
    };


    socket.on('send message', function(data, callback){

             var msg = data.msg.trim();

             if(msg.substr(0,3)==='/w '){
                console.log('whisper');
                msg = msg.substr(3);
                var ind = msg.indexOf(' ');
                if(ind !== -1){
                    var name = msg.substring(0, ind);
                    var msg = msg.substring(ind+1);
                    if(name in users){

                        users[name].emit('whisper', data);
                    }else{
                        callback('Enter a valid user')
                    }
                }else{
                        callback('Invalid whisper')
                }

             }else{
                io.sockets.emit('new message', data); //send to everyone
                //socket.broadcast.emit('new message', data); //send to everyone except me
             }
    });

    socket.on('disconnect', function(data){
            if(!socket.nickname) return;
            delete users[socket.nickname];
            updateNicknames();
    });

});

```


<br> 


#### index.html 

``` html

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat with socket.io</title>
    <style>
        #chat{
            height: 500px;
        }

        #contentWrap{
            display : none;
        }

        #chatWrap{
            float: left;
            border : 1px #000 solid;
        }

    </style>
</head>
<body>

    <div id="nickWrap">
        <p>Enter a username: </p>
        <p id="nickError"></p>
        <form id="setNick">
            <input type="text" size="35" id="nickname">
            <input type="submit" value="add nickname">
        </form>
    </div>


    <div id ='contentWRap'>
    <div id ='chat'></div>
    <form id="send-message">
        <input type="text" size="34" id="message">
        <input type="submit" value="add">
    </form>
    </div>
    <input type="hidden" id='hidden_name'>
    <div id="users"></div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    $(document).ready(function(){

        var socket = io.connect();
        var messageForm = $('#send-message');
        var messageBox = $('#message');
        var chat = $('#chat');
        var users = $('#users')
        var nickForm = $('#setNick');
        var nickError =$('#nickError');
        var nickBox = $('#nickname');

        nickForm.submit(function(e){
            e.preventDefault();
            $('#hidden_name').val(nickBox.val());

            socket.emit('new user', nickBox.val(), function(data){
                    if(data){
                        $('#nickWrap').hide();
                        $('#contentWrap').show();
                    }else{
                        nickError.html('That user name is already taken');
                    }
            });
            nickBox.val('');
        });


        socket.on('usernames', function(data){
                var html = '';

                $(users).html('');
                $(data).each(function(i, d){
                   $(users).append(d).append('<br>')
                })

        });


        messageForm.submit(function(e){
            e.preventDefault();
            socket.emit('send message', {name : $('#hidden_name').val(), msg: messageBox.val()}
            , function(data){

            });
            messageBox.val('');
        });


        socket.on('new message', function(data){
            chat.append(data.name+':\t'+data.msg+'<br/>');
        });


         socket.on('whisper', function(data){
            chat.append('whisper: '+data.name+':\t'+data.msg+'<br/>');
        });

    });

</script>


</body>
</html>

```





